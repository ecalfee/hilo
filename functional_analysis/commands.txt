# this is a functional analysis of outliers:
(I) Are domestication genes 'special' in terms of resistance to introgression?
(II) What does ancestry look like at specific known barrier-genes?
(III) Do we find evidence of elevation-associated mexicana introgression for genes associated with flowering time?


(0) Getting information about all genes.
I'm using the v4 annotations gff3: Zm00001d.2
To translate from other models, I downloaded the cross-reference: gene_model_xref_v4.txt. Deleting a few header and tail lines: geneAnnotations/gene_model_xref_v4_from_gramene.txt
# read that file into R enrichment_analysis.R (note: must use read.csv() or it skips about half the entries!!)
# used R to interactively print a resulting .bed file with all 45544 autosomal genes:
results/all_genes.v4.autosomal.sorted.bed
# got mean mexicana ancestry in maize and mexicana from another output file:
meanAlpha_maize.bed and meanAlpha_mex.bed (mean ancestry for every snp with an ancestry call)
# map mean ancestry onto genes:
functional_analysis$ parallel 'bedtools map -a results/all_genes.v4.autosomal.sorted.bed -b results/meanAlpha_{1}.bed -sorted -g ../data/refMaize/Zea_mays.AFPv4.dna.chr.autosome.lengths -o mean -c 4 > results/all_genes.meanAlpha_{1}.v4.autosomal.sorted.bed' ::: maize mex


# Windows analysis around genes: 10kb windows (gene +5kb either side of gene) and
# and 20kb windows (gene + 10kb either side)
# make windows 10kb around all genes:
functional_analysis$ bedtools slop -g ../data/refMaize/Zea_mays.AFPv4.dna.chr.autosome.lengths -b 5000 -i results/all_genes.v4.autosomal.sorted.bed > results/all_genes.10kb.v4.autosomal.sorted.bed
# 20kb:
functional_analysis$ bedtools slop -g ../data/refMaize/Zea_mays.AFPv4.dna.chr.autosome.lengths -b 10000 -i results/all_genes.v4.autosomal.sorted.bed > results/all_genes.20kb.v4.autosomal.sorted.bed

# map ancestry onto windows:
parallel 'bedtools map -a results/all_genes.{2}kb.v4.autosomal.sorted.bed -b results/meanAlpha_{1}.bed -sorted -g ../data/refMaize/Zea_mays.AFPv4.dna.chr.autosome.lengths -o mean -c 4 > results/all_genes.meanAlpha_{1}.{2}kb.v4.autosomal.sorted.bed' ::: maize mex ::: 10 20

# also map slope anc ~ env onto genes and windows:
functional_analysis$ parallel 'bedtools map -a results/all_genes{1}v4.autosomal.sorted.bed -b ../ZAnc/results/models/pass2_alloMAIZE/maize/simple_bElev_anc_maize.bed -sorted -g ../data/refMaize/Zea_mays.AFPv4.dna.chr.autosome.lengths -o mean -c 4 > results/all_genes.simple_bElev_anc_maize{1}v4.autosomal.sorted.bed' ::: . .10kb. .20kb.

(I) Domestication genes
Dan is re-doing the domestication scan with Li's maize landraces, looking for sweeps in maize
For now I can use the cross-pop LD-based domestication candidates from Hufford 2012
data/domestication/gene_model_translation_to_APGv4_Zm00001d.2_hits.txt #only about half could be found in v4 gene set

Hufford 2012 Domestication Genes downloaded from Supplementary table 6:
Letter | Published: 03 June 2012
Comparative population genomics of maize domestication and improvement
Matthew B Hufford, Xun Xu, Joost van Heerwaarden, Tanja Pyhäjärvi, Jer-Ming Chia, Reed A Cartwright, Robert J Elshire, Jeffrey C Glaubitz, Kate E Guill, Sha$
Nature Genetics volume 44, pages 808–811 (2012)

This paper used a comparison of XP-CLR cross-population composite likelihood ratio statistic (Chen 2010)
to identify regions of the genome with elevated divergence between parviglumis and maize landraces
extending over large regions, consistent with fast rises in frequency (ie selection) during domestication
Candidate genes were identified within these elevated regions.

(II) Barrier gene candidates
Putative Ga2 loci male and female (right next to each other)
GRMZM2G410783, AC231426.1_FG002
5.30.19 Jeff gave me gene candidates for the incompatibility loci Ga2 (male and female).
I used maizeGDB to look up the positions of those candidate genes and got positions for v1, v2, and v3 (5b+) reference genomes.
https://www.maizegdb.org/gene_center/gene
The gene annotation for reference genome v4 is comparatively poor and doesn't have these genes annotated but I can either
(1) match by sequence
(2) liftover from v3 to v4 coordinates - did this using http://ensembl.gramene.org/Zea_mays/Tools/AssemblyConverter
The v4 coordinates are saved as GRMZM2G410783_v4_coord.bed (female Ga2) and AC231426.1_FG002_v4_coord.bed (male Ga2)


(III) Flowering time pathway and GWAS hits
# All flowering time genes are written for v3 gene sets:
(a) Li Wang's candidate genes. PBE = Population Branch Excess. MH = mexico highland PBE outlier, US is US Southwest, GH is Guatemala HIghland, AN is Andean
(b) Dong 2012 pathway analysis using QTL/functional studies and componenets of Arabidopsis pathway (n=48)
data/flowering_time/floweringTimeMaizeDong2012.csv
(c) Navarro 2017. F1 association mapping study 'FOAM GWAS' using landraces across the Americas.
(d) I could alternatively use a set of 220 flowering time candidates from Yong-xiang Li 2016 https://onlinelibrary.wiley.com/doi/pdf/10.1111/tpj.13174 from NAM US + NAM CHINA + natural pop AMES (all RILs; ~8.7k total; GWAS). But I think Navarro 2017 is better because it includes variation from the highlands specifically vs. NAMs
# all combined I am getting 1637 candidate flowering time genes mapped to v4
# I can do other things later to get more of them (e.g. liftover)


# I downloaded the full set of conversions between v3 and all other gene sets (including v4)
# then I removed extra lines
hilo$ cat data/refMaize/geneAnnotations/gene_model_xref_v3.txt | tail -n +5 | head -n -4 > data/refMaize/geneAnnotations/gene_model_xref_v3_from_maizeGDB.txt

# I made a bed file of the combined set of genes in the gff, extended it by 5 to 10kb in both directions away from the gene and found the mean ancestry from overlap with the ancestry calls.
# more details here: ../data/domestication/README.txt
# all genes sorted, filtered for autosomal:
hilo/data/domestication/all_genes.autosomal.sorted.bed
# e.g. adding 5kb either side and finding mean alpha (% mexicana introgression) in maize:
hilo/data/domestication/meanAlpha_maize.bed
hilo/data/domestication/all_genes.meanAlpha_maize.10kb.autosomal.sorted.bed
For flowering time I want to do the same thing but with estimated anc ~ elevation slope instead of mean ancestry.
# so first I need to make a bed file with the slopes from my linear model
hilo/ZAnc$ tail -n +2 results/models/pass2_alloMAIZE/maize/simple_bElev_anc.txt | cut -f2 | paste ../data/domestication/meanAlpha_maize.bed - | cut -f1-3,5 > results/models/pass2_alloMAIZE/maize/simple_bElev_anc_maize.bed
# then I map those slope values onto my gene set:
../data/domestication$ bedtools map -a all_genes.10kb.autosomal.sorted.bed -b ../../ZAnc/results/models/pass2_alloMAIZE/maize/simple_bElev_anc_maize.bed -sorted -g ../refMaize/Zea_mays.AFPv4.dna.chr.autosome.lengths -o mean -c 4 > all_genes.simple_bElev_anc_maize.10kb.autosomal.sorted.bed
# then in R I test if the flowering time genes are significantly different from other genes in their slopes with ancestry

# ab10 meiotic drive on chromosome 10. THIS IS REALLY FAST PER FILE < 30 minutes for most (but not all)
# I have a hit near this on chromosome 10, so I'm checking with a re-map to
# a small fasta that has just ab10 meiotic drive locus and similar looking regions from the maize genome
# for competitive mapping (saved in ../data/ab10/kinesins.fa):
# First I map the January 2019 samples:
functional_analysis$ sbatch --array=0-113 --partition bigmemm --export=DIR_IN=../data/HILO_raw_reads,PREFIX_LIST=Jan2019 map_and_filter_reads_ab10.sh
Submitted batch job 14064986 - RUNNING 9.13.19. Oops I only want to keep reads that map -q 1. Try again:
Submitted batch job 14065897 - RUNNING 9.13.19
# Then I map the earlier March 2018 samples to this locus:
functional_analysis$ sbatch --array=0-198 --partition bigmemm --export=DIR_IN=../data/HILO_raw_reads,PREFIX_LIST=March2018_all map_and_filter_reads_ab10.sh
Submitted batch job 14065486 - RUNNING 9.13.19. cancel and retry with map -q 1 filter:
Submitted batch job 14065785 - RUNNING 9.13.19
# for allopatric maize, I have to map back 3 fastqs (3rd is for unpaired reads)
functional_analysis$ sbatch -p bigmemm --array=0-14 --export=ID_DIR=../data/landraces_fromLi,DIR_IN=../data/landraces_fromLi/original/fastq,PREFIX_LIST=alloMAIZE threefastq2ab10.sh
Submitted batch job 14112708 - RUNNING 9.17.19
# TO DO: call variants and do a PCA of ab10 region for all samples. check correlation with maize vs. mexicana ancestry calls for that region.

# report overall mean mexicana ancestry in maize and mexicana across the genome
# as a bed file, where ancestry calls are extended into tracts going midway to the next call.
# (gave to Dan May 8 2020 to compare to domestication scan)
(base) Erins-MacBook-Air:hilo Erin$ cut -f4 functional_analysis/results/meanAlpha_maize.bed | paste local_ancestry/results/thinnedSNPs/pass2_alloMAIZE/tracts.bed - > functional_analysis/results/meanAlpha_maize_tracts.bed
(base) Erins-MacBook-Air:hilo Erin$ cut -f4 functional_analysis/results/meanAlpha_mex.bed | paste local_ancestry/results/thinnedSNPs/pass2_alloMAIZE/tracts.bed - > functional_analysis/results/meanAlpha_mex_tracts.bed
