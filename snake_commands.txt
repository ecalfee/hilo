# 7.6.2021
started new screen
ecalfee@farm:~$ srun -p high2 --mem 16G -t 10-00:00:00 --pty bash
ecalfee@c6-54:~$ module load conda3
ecalfee@c6-54:~$ source activate hilo-env
hilo$ ls mhl1_inv/results/HILO_MAIZE55_PARV50/K3/Ne10000_yesBoot/ # has no files so it should re-run
# uncommented a bunch of results/plots for diversity and mhl1_inv to try to run on snakemake
(hilo-env) ecalfee@c6-54:~/hilo$ snakemake -n some diversity --profile slurm --quiet
MissingInputException in line 436 of /home/ecalfee/hilo/Snakefile:
Missing input files for rule diversity: # oops I needed to import diversity/Snakefile -- trying again:
(hilo-env) ecalfee@c6-54:~/hilo$ snakemake some diversity --profile slurm --quiet
Job counts:
        count   jobs
        4       calc_fst_all_outliers
        4       calc_fst_idx_outliers
        2       calc_pi_all_chr
        8       calc_pi_all_outliers
        5       calc_thetas_outliers
        1       diversity
        4       estimate_saf_pop_outliers
        2       get_GL_mhl1_inv
        2       get_mhl1_inv_coord
        2       plot_mhl1_inv
        2       plot_mhl1_inv_PCAngsd
        1       plot_shared_peaks # errors -- check
        2       plot_within_ancestry_fst # errors -- check
        1       plot_within_ancestry_fst_pi_peaks
        1       print_fst_ancestry_peaks_one_file
        1       print_pi_mexicana_peaks_one_file
        1       print_pi_one_file
        2       run_PCAngsd_mhl1_inv
        1       some
        46 # RUNNING 7.6.2021 after using --unlock (not sure why the directory was locked .. nothing is running of mine on squeue but perhaps the 10 days timed out and killed previous snakemake if there were errors in creating some files (?))

# I don't understand why there are no updates to this figure (doesn't trigger git to add and it's made June 9 but I thought it'd rerun..):
hilo_manuscript$ git add figures/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot_mhl1_inv_pca.png
# hmmm... I need to check on this!
ecalfee@c6-54:~/hilo_manuscript$ ls -lh figures_supp/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot_mhl1_inv_pca.tif
-rw-rw-r-- 1 ecalfee ecalfee 141K Jul  6 13:05 figures_supp/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot_mhl1_inv_pca.tif
ecalfee@c6-54:~/hilo_manuscript$ ls -lh figures/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot_mhl1_inv_pca.png
-rw-rw-r-- 1 ecalfee ecalfee 148K Jun  9 07:31 figures/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot_mhl1_inv_pca.png
# re-doing some tables and adding them to rule 'some':
hilo_manuscript$ git rm -f tables/spearmans_rho_f4_sympatric_mexicana_pop22.tex
rm 'tables/spearmans_rho_f4_sympatric_mexicana_pop22.tex'
ecalfee@c6-54:~/hilo_manuscript$ rm ../hilo/ancestry_by_r/tables/spearmans_rho_f4_sympatric_mexicana_pop22.tex
# updated all the main and supporting figures/tables in rule all for K=3 analyses. Now running snakemake to see what still needs to be completed:
hilo$ snakemake -n all --profile slurm --quiet
Missing input files for rule all:
../hilo_manuscript/figures_supp/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot/maize_shared_outliers_chr_9.tif # fixed / -> _
domestication_scan/tables/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot_genes_mapped_to_outliers.tex # folder should be ZAnc/tables
diversity/plots/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot_pi_within_maize_ancestry_peaks.png # not peaks, just within maize ancestry generally
diversity/plots/HILO_MAIZE55/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot_local_fst_within_mexicana_ancestry_peaks.png # removed extra HILO_MAIZE55/
hilo$ snakemake all --profile slurm --quiet
Job counts:
        count   jobs
        1       all
        2       calc_and_plot_f4 # Error executing rule calc_and_plot_f4 on cluster (jobid: 6, external: 36692430)
        # error is more complicated..need to inspect further maybe running the script manually
        85      do_abba_baba # not entirely sure why this rerun was triggered but ok
        # Error executing rule do_abba_baba on cluster (jobid: 6977, external: ) OUT OF MEMORY (see if it works on rerun)
        1       f4_from_abba_baba
        4       plot_mean_anc
        1       plot_shared_peaks # Error executing rule plot_shared_peaks on cluster (jobid: 4, external: 36692463. Fixed: needed to output tif to figures_supp/
        1       plot_within_ancestry_fst
        95 # RUNNING 6.7.2021
stuck on an abba baba but nothing running on squeue so I did CTRL+C to cancel this snakemake 7.8.2021
hilo$ snakemake -n all --profile slurm --quiet

# fixed main figure on ancestry ~ r and removed old file to trigger a rerun next time I do snakemake:
hilo$ rm ancestry_by_r/plots/HILO_MAIZE55_PARV50_K3_by_r_multi_panel.png

# SOME RULES WERE RUNNING BUT FOR SOME REASON THIS LOG CRASHED AND DIDN'T SAVE THE JOB LOG  I'D COPY PASTED IN :( .
# anyways, rules runing included making Ne plots and re-making multi-panel as well as some abba baba and f4 that didn't run successfully
# some errors:
plot_shared_peaks 36718769 # fixed typo
Job completed successfully, but some output files are missing. Missing files after 120 seconds:
../hilo_manuscript/figures_supp/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot_combmatrix_peak_sharing_mexicana.tif
calc_and_plot_f4 36718743 # See if abba_baba's finishing fixes this (?)
Called processing error for snakemake??
Warning messages:
1: In ggs[i] <- p :
  number of items to replace is not a multiple of replacement length


# deleted some files so they'll rerun:
ecalfee@c6-56:~/hilo$ rm global_ancestry/plots/HILO_MAIZE55_PARV50_pca.png
ecalfee@c6-56:~/hilo$ rm mhl1_inv/plots/HILO_MAIZE55_PARV50_K3_Ne10000_yesBoot_mhl1_inv_pca.png


# f4 from abba_baba failed a few times e.g. 36720743
hilo$ snakemake all --profile slurm --quiet # 7.8.2021 6:30pm
# plot_within_ancestry_fst failed 36721164 # Error in grDevices::png(..., res = dpi, units = "in") : invalid 'filename' argument
# also calc_and_plot_f4 failed 36721167
# and plot_mean_anc failed 36721163 # FIXED: needed to remove shadow or just make a different script to combine the supplementary figs for this...

- HOW MANY BOOTSTRAPS 'AMBIGUOUS' for NGSAdmix ancestry? Add 2 methods...say a range of how many were dropped per set of bootstraps (or max or something).


# TO DO:
FINISH FIXING UP 'TEST_KEY_GENES' rule -- look at all input files, fix prefixes to be maize_anc and lm_elev
CHECK ON HPC1 RESULTS.
CHECK CORRELATIONS ARE PROPERLY UPDATED IN MAIN TEXT
FIX ALL INTROGRESSION DESERT RESULTS (really lack of crop-wild introgression here..)
CAN ALSO TRY IF YOU HAVE TIME TO GET PI WITHIN THE INVERSION
FORMAT ALL TABLES AS EXTRA FILES FOR UPLOAD TO PLOS GENETICS
       # instead of MAKE SMALLER SPEARMAN'S RHO TABLES (or turn sideways). Same with domestication genes table.
# Qs for JEFF/GRAHAM
- Show new figures
- PARV also changes across recombination rate. local ancestry ~ r just a tad different
- show them inversion pca at mhl1 -- segregates at parviglumis...should we say it could be ancestrally sorting?
----actually re-do this first to make sure it's not spurious because of background (outside inversion)
- Still running last couple plots (QQs/Nes/Pi + Fst within local ancestry peaks)

# add back in f4 tables to github.
# add plots for robustness of ancestry_hmm to choice of Ne -- reference in methods
# Language : modeled ancestry variance-covariance marginally, marginal K matrix


# ASK IF THE EQUATION IN SORAGGI SHOULD HAVE A NEGATIVE IN THE NUMERATOR
# PREP FOR PRESENTATION:
# (1) Get list of flowering time GWAS hits and compare overlap. If time, at end, control for recombination rate using BEDTools
# (2) Plot freq in maize vs. freq in mexicana with domestication loci highlighted a different color
