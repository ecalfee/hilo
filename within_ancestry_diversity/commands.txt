# This analysis looks at within-ancestry diversity to assess
# (1) is there evidence of bottlenecks or sweeps for outlier introgressed regions
# This analysis compares pi within introgressed segments to pi within local and allopatric populations for the same regions
# (2) what is the likely source population for adaptive introgression and is it the same across populations?
# This analysis uses Fst calculations between introgressed segments and potential donor populations that are sympatric or allopatric

# Step 1: use R and bedtools to identify regions with homozygous ancestry for each individual:

# 1a: R script makes short tracts around variant sites: ancestry_sites_to_tracts.R
within_ancestry_diversity$ Rscript ./ancestry_sites_to_tracts.R ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM
# (I ran on barbara & copied result file over to farm. only need to run once for all chr and all samples)
# 1b: then use awk to identify which tracts have posterior > 0.8
# and bedtools to merge adjacent tracts
# TESTING:
hilo/within_ancestry_diversity$ pr -mt -s$'\t' results/input/var.sites.bed  \
<(tail -n +2 ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot/HILO1.posterior | cut -f3) \
| awk '$4 > 0.8 {print $0}' | bedtools merge -sorted -d 1 | head > results/input/hom_maize/tracts/HILO1.bed

# Step 2: use bedtools to filter bam files to only include regions homozygous for ancestry (identified in .bed files above)
# TESTING:
hilo/within_ancestry_diversity$ bedtools intersect -sorted -a ../filtered_bams/results/pass1/HILO1.sort.dedup.baq.bam \
-b results/input/hom_maize/tracts/HILO1.bed > results/input/hom_maize/bams/HILO1.sort.dedup.baq.bam

# running all HILO individuals with new script for 1b & 2 (find tracts and filter bams):
within_ancestry_diversity$ sbatch --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot get_homozyg_tracts_and_bams.sh
Submitted batch job 9175362 - cancelled (typo bams vs. bam) 2.27.19. rerunning:
Submitted batch job 9175657 - I CANCELLED 2.27.19. Actually, want to split into 2 scripts so I can prioritize looking at mexicana ancestry in maize:
within_ancestry_diversity$ sbatch --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot get_homozyg_tracts_and_bams_mexicana.sh
Submitted batch job 9175973 - 2.27.19. Redoing #68:
sbatch --array=68 --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot get_homozyg_tracts_and_bams_mexicana.sh
Submitted batch job 9233049 - COMPLETED 2.28.19
within_ancestry_diversity$ sbatch --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot get_homozyg_tracts_and_bams_maize.sh
Submitted batch job 9176068 - RAN 2.27.19

# TO DO: for populations with no admixture from NGSadmix, either use all of bams, or rely
# on posteriors from very low (.001) admixture prior

# high maize prior:
output_very_high_maize_prior_noBoot - pops 361,369,371

within_ancestry_diversity$ sbatch -t 24:00:00 --array=$(for i in 361 369 371; do cat ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/input/pop"$i".anc_hmm.ids; done | sort --version-sort | paste -sd",") --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_very_high_maize_prior_noBoot get_homozyg_tracts_and_bams_mexicana.sh
Submitted batch job 9181138 - COMPLETED (fast) 2.27.19

within_ancestry_diversity$ sbatch -t 24:00:00 --array=$(for i in 361 369 371; do cat ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/input/pop"$i".anc_hmm.ids; done | sort --version-sort | paste -sd",") --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_very_high_maize_prior_noBoot get_homozyg_tracts_and_bams_maize.sh
Submitted batch job 9181158 - COMPLETED (fast) 2.27.19

# low maize prior:
output_very_high_mex_prior_noBoot - pops 25,27,31,(35 - used as allopatric pop in pass1; for now exclude)

within_ancestry_diversity$ sbatch -t 24:00:00 --array=$(for i in 25 27 31; do cat ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/input/pop"$i".anc_hmm.ids; done | sort --version-sort | paste -sd",") --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_very_high_mex_prior_noBoot get_homozyg_tracts_and_bams_mexicana.sh
Submitted batch job 9181177 - COMPLETED 2.27.19

within_ancestry_diversity$ sbatch -t 24:00:00 --array=$(for i in 25 27 31; do cat ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/input/pop"$i".anc_hmm.ids; done | sort --version-sort | paste -sd",") --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_very_high_mex_prior_noBoot get_homozyg_tracts_and_bams_maize.sh
Submitted batch job 9181198 - COMPLETED 2.27.19

# NEED TO REDO:
# which individuals are missing?
within_ancestry_diversity$ for i in $(cat results/input/mex2/pops/symp.mexicana.list results/input/mex2/pops/symp.maize.list); do echo $i; samtools view -H $i | head -n 1; done
71,73,75,77,78,79,104,190 # of these, 71 is in the very high mex prior and the rest regular
within_ancestry_diversity$ sbatch -t 5:00:00 --array=71 --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_very_high_mex_prior_noBoot get_homozyg_tracts_and_bams_mexicana.sh
Submitted batch job 9295897 - ERROR 2.28.19 -- ACK HILO71 needs to be redone. Empty bam. I'll skip for now.
within_ancestry_diversity$ sbatch -t 5:00:00 --array=73,75,77,78,79,104,190 --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot get_homozyg_tracts_and_bams_mexicana.sh
Submitted batch job 9295917 - COMPLETE 2.28.19 (BUT 190 has no posterior; ok to skip -- it's low coverage)
within_ancestry_diversity$ sbatch -t 5:00:00 --array=71 --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_very_high_mex_prior_noBoot get_homozyg_tracts_and_bams_maize.sh
Submitted batch job 9296388 - ERROR 2.28.19 -- ACK HILO71 needs to be redone. Empty bam. I'll skip for now.
within_ancestry_diversity$ sbatch -t 5:00:00 --array=76,84,87,92,104,190 --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot get_homozyg_tracts_and_bams_maize.sh
Submitted batch job 9296442 - COMPLETE 2.28.19 (Except 190 has no posterior; ok to skip -- it's low coverage)

# NEW PLAN: FOR A FIRST PASS, JUST CALCULATE ALLELE FREQ. FOR EACH POP. ONLY INCLUDING READS FROM HOMOZYGOUS REGIONS:
# THEN CALCULATE PI AND FST ESTIMATES FROM THESE ALLELE FREQs IN R -- I can refine this approach later.
# allele frequencies for allo4low16 maize and allopatric mexicana already exist:
hilo/data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt/maize.allo.4Low16/region_399.mafs.gz
hilo/data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt/mexicana.allo.withXochi35/region_399.mafs.gz
# and I already have the list of variant sites, e.g.:
hilo/data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt/region_163.var.sites

# get lists of bams to use from hilo populations:
within_ancestry_diversity$ mkdir -p results/input/mex2/pops; for i in $(awk '$1 != "n" && $11 >= 0.05 {print $3}' ../data/pass1_ids.txt | sort | uniq); do awk -F $'\t' -v i=$i '$3 == i && $11 >= 0.05 && $2 != "HILO71" {print "results/input/mex2/bams/HILO"$1".sort.dedup.baq.bam"}' ../data/pass1_ids.txt > results/input/mex2/pops/pop$i.list; done
within_ancestry_diversity$ mkdir -p results/input/maize2/pops; for i in $(awk '$1 != "n" && $11 >= 0.05 {print $3}' ../data/pass1_ids.txt | sort | uniq); do awk -F $'\t' -v i=$i '$3 == i && $11 >= 0.05 && $2 != "HILO71" {print "results/input/maize2/bams/HILO"$1".sort.dedup.baq.bam"}' ../data/pass1_ids.txt > results/input/maize2/pops/pop$i.list; done
# NOTE: I exclude 71 for now (needs bam alignment redone)

# also make a list of new allopatric maize bams:
within_ancestry_diversity$ ls ../filtered_bams/results/alloMAIZE/*.sort.dedup.baq.bam | sort --version-sort > results/input/maize2/pops/landraces.list
# allo mexicana (assumed every part of genome is diploid mex. ancestry ):
within_ancestry_diversity$ for i in 20 22 33 35; do awk -F $'\t' -v i=$i '$3 == i && $11 >= 0.05 && $2 != "HILO71" {print "../filtered_bams/results/pass1/HILO"$1".sort.dedup.baq.bam"}' ../data/pass1_ids.txt > results/input/mex2/pops/pop$i.list; done
within_ancestry_diversity$ for i in 20 22 33 35; do cat results/input/mex2/pops/pop$i.list; done > results/input/mex2/pops/allo.mexicana.list

# and get sympatric maize and mexicana all together:
within_ancestry_diversity$ for j in {360..363} {365..374}; do cat results/input/mex2/pops/pop$j.list; done > results/input/mex2/pops/symp.maize.list
within_ancestry_diversity$ for j in {360..363} {365..374}; do cat results/input/maize2/pops/pop$j.list; done > results/input/maize2/pops/symp.maize.list
within_ancestry_diversity$ for j in 18 19 21 {23..31} 34; do cat results/input/mex2/pops/pop$j.list; done > results/input/mex2/pops/symp.mexicana.list
within_ancestry_diversity$ for j in 18 19 21 {23..31} 34; do cat results/input/maize2/pops/pop$j.list; done > results/input/maize2/pops/symp.mexicana.list

# I can just use the already-calculated allele freq's for old allopatric maize and mex.

# start with getting allele frequencies for maize landraces:
within_ancestry_diversity$ sbatch --export="POP=landraces,PREFIX=maize2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL" calcAlleleFreqPopByCounts.sh
Submitted batch job 9189903 - typo, fixing 2.27.19:
Submitted batch job 9191743 - RUNNING 2.27.19

# then for all populations (homozygous mexicana tracts):
within_ancestry_diversity$ for i in {18..31} {33..35} {360..363} {365..374}; do sbatch \
--export=POP=pop"$i",PREFIX=mex2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL \
calcAlleleFreqPopByCounts.sh; done
Submitted batch job 9190332-9190362 - 2.27.19. Error only for population 23. And allopatric pops not really run (20,22,33,35). RERUNNING:
within_ancestry_diversity$ sbatch --export=POP=pop23,PREFIX=mex2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL calcAlleleFreqPopByCounts.sh
Submitted batch job 9230594 - 2.28.19. REDID mex2 bam for HILO68, now rerunning again:
within_ancestry_diversity$ sbatch --dependency=afterok:9233049 --export=POP=pop23,PREFIX=mex2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL calcAlleleFreqPopByCounts.sh
Submitted batch job 9233271 -  COMPLETED 2.28.19. REDID mex2 bam for a few individuals and rerunning:
within_ancestry_diversity$ for i in 19 21 28 31 366 370 374; do sbatch \
--export=POP=pop"$i",PREFIX=mex2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL \
calcAlleleFreqPopByCounts.sh; done
Submitted batch job 9298015-21 - RUNNING 2.28.19
# also running all sympatric individuals as a group to get larger n and big picture:
within_ancestry_diversity$ for i in symp.maize symp.mexicana; do sbatch \
--export=POP="$i",PREFIX=mex2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL \
calcAlleleFreqPopByCounts.sh; done
Submitted batch job 9302206-7 - RUNNING 2.28.19. RERUNNING AFTER ACTUALLY EXCLUDING HILO71
within_ancestry_diversity$ sbatch --export=POP=symp.mexicana,PREFIX=mex2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL calcAlleleFreqPopByCounts.sh
Submitted batch job 9305854 - 2.29.19. Looks complete.
within_ancestry_diversity$ sbatch --export=POP=pop31,PREFIX=mex2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL calcAlleleFreqPopByCounts.sh
Submitted batch job 9305983 - 2.29.19 # affected by HILO71. LOOKS COMPLETE

# all populations homozygous maize tracts too (lower priority):
within_ancestry_diversity$ for i in {18..31} {33..35} {360..363} {365..374}; do sbatch \
--export=POP=pop"$i",PREFIX=maize2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL \
calcAlleleFreqPopByCounts.sh; done
Submitted batch job 9191136,9191184-9191213 - 2.27.19. Completed except skipping allopatric pops.
# remade some of the individual bams and redoing those populations:
within_ancestry_diversity$ for i in 21 28 31 367 370 373; do sbatch \
--export=POP=pop"$i",PREFIX=maize2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL \
calcAlleleFreqPopByCounts.sh; done
Submitted batch job 9300912-17 - RUNNING 2.28.19
# running all sympatric individuals as one population:
within_ancestry_diversity$ for i in symp.maize symp.mexicana; do sbatch \
--export=POP="$i",PREFIX=maize2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL \
calcAlleleFreqPopByCounts.sh; done
Submitted batch job 9302554-5 - RUNNING 2.28.19



# TO DO: FOR A SET OF RANDOM REGIONS, AS WELL AS SOME OUTLIERS with high mex ancestry, use angsd to calculate Fst
# between homozygous mexicana tracts in sympatric mexicana, sympatric maize, and allopatric mexicana. Also calculate pi.

# First ID a set of outlier regions with high mexicana ZAnc scores and > 100kb, say 100 longest high mex outlier regions
# put all ancestry calculations in one place and calculate ZAnc
# like get_homozyg_tracts_and_bams_mexicana.sh I want to make tracts

# lookign at pi and fst in specific outlier regions:
# testing script with one small 20kb outlier
within_ancestry_diversity$ sbatch --array=0 --export=OUTLIERS=test.bed,PREFIX=mex2 piFstAngsd_outliers.sh
Submitted batch job 9305844 - fixing errors:
within_ancestry_diversity$ sbatch --array=0 --export=OUTLIERS=../ZAnc/results/test.bed,PREFIX=mex2 piFstAngsd_outliers.sh
Submitted batch job 9305846 - typo. still didn't work. fixed list of allopatric mex. bams:
Submitted batch job 9305851. problem need to exclude HILO71:
Submitted batch job 9306046 - slurm segmentation fault. trying again:
within_ancestry_diversity$ sbatch --array=0 -t 2:00 -p low --export=OUTLIERS=../ZAnc/results/test.bed,PREFIX=mex2 piFstAngsd_outliers.sh
Submitted batch job 9306709 - segfaults may be part of doThetas issue. But i'll try one more time without n_threads
Submitted batch job 9306710 - trying with slightly larger region (maybe no sites? seems unlikely but ok). still seg. fault.
Submitted batch job 9306711 - found an error where region was size zero (!). retry:
Submitted batch job 9306713 - try again
Submitted batch job 9306714 - ran out of time but seemed to move past doThetas (yay!)

# now running my jobs for 26 outliers:
within_ancestry_diversity$ sbatch --array=0-25 --mem=8G --export=OUTLIERS=../ZAnc/results/pass1_maize/outliers.bed,PREFIX=mex2 piFstAngsd_outliers.sh
Submitted batch job 9306742 - RUNNING 2.29.19
# I may need additional angsd tools to view and interpret output
# these are written as 'log scale per site thetas'
# e.g. thetaStat print out.thetas.idx. Can also print as sliding window http://www.popgen.dk/angsd/index.php/Thetas,Tajima,Neutrality_tests

# windows of pi:
chr1_5865576-6182939$ thetaStat do_stat allo.mexicana.thetas.idx -outnames allo.mexicana.thetasAll
mex2/chr1_20487201-21009933$ thetaStat do_stat allo.mexicana.thetas.idx -win 5000 -step 1000 -outnames allo.mexicana.thetasWindow
mex2/chr1_20487201-21009933$ realFst stats2 symp.maize-allo.mexicana.fst.idx -win 5000 -step 1000 -outnames symp.maize-allo.mexicana.fstWindow

# making output files for all (can add to script later):
module load bio # interactive session
# theta all sites together
within_ancestry_diversity/results/piFst_outliers/mex2$ for i in $(ls -d chr*_*-*); do for j in symp.maize symp.mexicana allo.mexicana; do thetaStat do_stat "$i"/"$j".thetas.idx -outnames "$i"/"$j".thetasAll; done; done
# theta windows
within_ancestry_diversity/results/piFst_outliers/mex2$ for i in $(ls -d chr*_*-*); do for j in symp.maize symp.mexicana allo.mexicana; do thetaStat do_stat "$i"/"$j".thetas.idx -win 5000 -step 1000 -outnames "$i"/"$j".thetasWindows; done; done
# Fst all sites together (much slower than thetas)
within_ancestry_diversity/results/piFst_outliers/mex2$ for i in $(ls -d chr*_*-*); do for j in symp.maize-allo.mexicana symp.maize-symp.mexicana symp.mexicana-allo.mexicana; do realSFS fst stats2 "$i"/"$j".fst.idx > "$i"/"$j".fstAll; done; done
# Fst windows (much slower than thetas)
within_ancestry_diversity/results/piFst_outliers/mex2$ for i in $(ls -d chr*_*-*); do for j in symp.maize-allo.mexicana symp.maize-symp.mexicana symp.mexicana-allo.mexicana; do realSFS fst stats2 "$i"/"$j".fst.idx -win 5000 -step 1000 > "$i"/"$j".fstWindows.stats; done; done
# windows was fast

# copy results over:
within_ancestry_diversity/results/piFst_outliers/mex2$ for i in $(ls -d chr*); do scp -P 2022 ecalfee@farm.cse.ucdavis.edu:~/hilo/within_ancestry_diversity/results/piFst_outliers/mex2/"$i"/*.thetasAll.pestPG "$i"/.; done
within_ancestry_diversity/results/piFst_outliers/mex2$ for i in $(ls -d chr*); do scp -P 2022 ecalfee@farm.cse.ucdavis.edu:~/hilo/within_ancestry_diversity/results/piFst_outliers/mex2/"$i"/*.thetasWindows.pestPG "$i"/.; done


# windows of Fst:
realSFS fst stats2 symp.maize-allo.mexicana.fst.idx -win 5000 -step 1000 -outnames symp.maize-allo.mexicana.fstWindow.gz


# Extended each outlier region by 100 kb to either side to view context:
hilo/ZAnc/results/pass1_maize$ bedtools slop -i outliers.bed -g ../../../data/refMaize/Zea_mays.B73_RefGen_v4.dna.toplevel.dict -b 100000 > outliers_100kb_flanking.bed
within_ancestry_diversity$ sbatch --array=0-25 -p med2 --export=OUTLIERS=../ZAnc/results/pass1_maize/outliers_100kb_flanking.bed,SUBDIR_OUT=piFst_outliers_100kb_flanking,PREFIX=mex2 piFstAngsd_outliers.sh
Submitted batch job 9767346 - started 3.13.19 COMPLETED, BUT rerunning some that failed due to low memory:
"Some of your processes may have been killed by the cgroup out-of-memory handler"
within_ancestry_diversity$ sbatch --array=0,24 --mem=16G -t 12:00:00 -p med2 --export=OUTLIERS=../ZAnc/results/pass1_maize/outliers_100kb_flanking.bed,SUBDIR_OUT=piFst_outliers_100kb_flanking,PREFIX=mex2 piFstAngsd_outliers.sh
Submitted batch job 9768108 - RUNNING 3.13.19


# Now making 1000 random 10kb regions to get background Fst/theta (10Mb total)
hilo/data/refMaize$ bedtools random -l 10000 -n 1000 -seed 123 -g Zea_mays.B73_RefGen_v4.dna.toplevel.fa.fai | bedtools shuffle -noOverlapping -seed 123 -g Zea_mays.B73_RefGen_v4.dna.toplevel.fa.fai | bedtools sort -faidx Zea_mays.B73_RefGen_v4.dna.toplevel.fa.fai | awk '{print $1":"$2"-"$3}' > random_regions/N1000L10kb.regions
# script to calculate pi for each population and metapopulation at a set of random regions.
within_ancestry_diversity$ sbatch --export=REGIONS=N1000L10kb,PREFIX=mex2 piFstAngsd_background.sh
Submitted batch job 9768115 - RUNNING 3.13.19

# running within-ancestry pi analysis for new outliers defined by high mean ancestry across populations
results/pass1_maize/outliers_mean_anc0.6.bed
ZAnc/results$ bedtools slop -i pass1_maize/outliers_mean_anc0.6.bed -g ../../data/refMaize/Zea_mays.B73_RefGen_v4.dna.toplevel.dict -b 100000 > pass1_maize/outliers_mean_anc0.6_100kb_flanking.bed
within_ancestry_diversity$ sbatch --array=0-21 -p med2 --mem=16G --export=OUTLIERS=../ZAnc/results/pass1_maize/outliers_mean_anc0.6.bed,SUBDIR_OUT=piFst_outliers_mean_anc0.6,PREFIX=mex2 piFstAngsd_outliers.sh
Submitted batch job 9785033 - RUNNING 3.14.19
within_ancestry_diversity$ sbatch --array=0-21 -p med2 --mem=16G --export=OUTLIERS=../ZAnc/results/pass1_maize/outliers_mean_anc0.6_100kb_flanking.bed,SUBDIR_OUT=piFst_outliers_mean_anc0.6_100kb_flanking,PREFIX=mex2 piFstAngsd_outliers.sh
Submitted batch job 9785060 - RUNNING 3.14.19
# copying over results, e.g.:
hilo/within_ancestry_diversity/results$ for i in $(awk '{print "chr"$1"_"$2"-"$3}' ../../ZAnc/results/pass1_maize
/outliers_mean_anc0.6_100kb_flanking.bed); do mkdir -p piFst_outliers_mean_anc0.6_100kb_flanking/mex2/$i; scp -P 2022 ecalfee@farm.cse.ucdavis.edu:~/hilo/within_ancestry_diversity/results/piFst_outliers_mean_anc0.6_100kb_flanking/mex2/$i/*.pestPG piFst_outliers_mean_anc0.6_100kb_flanking/mex2/$i/.; done
# TO DO: check that the ones with empty or no files actually have no high-confidence mexicana ancestry for that region, e.g. piFst_outliers_mean_anc0.6_100kb_flanking/mex2/chr4_179066701-179636563/pop371
# e.g. results/piFst_outliers_mean_anc0.6_100kb_flanking/mex2/chr1_0-132525$ head pop365.thetasWindows.pestPG has zero sites in thetaWindows but does have a mean thetasAll -- why?


# calculating genomewide allele frequencies for all populations (for background Fst and f4 etc)
# I also calc frequencies for outgroups like parviglumis but only at SNPs segregating in pass2 & alloMAIZE landraces
# Calculate allele frequencies genomewide using a counts-based method for each population:
# allopatric maize, allopatric mexicana, sympatric maize, sympatric mexicana, parviglumis, individual hilo pops, tripsacum:
# parviglumis has much higher total depth (so I increase memory):
# make symlink:
within_ancestry_diversity$ mkdir -p results/input/parv/pops
within_ancestry_diversity$ ln -s /home/ecalfee/hilo/samples/PalmarChico_bams.list results/input/parv/pops/PalmarChico.list
# run allele freq calc:
within_ancestry_diversity$ sbatch -p med2 --mem=24G --export="POP=PalmarChico,PREFIX=parv,DIR_SITES=../variant_sites/results/pass2_alloMAIZE,ALL" calcAlleleFreqPopByCounts.sh
Submitted batch job 10460546 - RUNNING 4.23.19
# moved into folder with other files:
within_ancestry_diversity/results/allele_freq$ mv parv/PalmarChico/ all/parv

# allopatric maize also has high total depth (so I increase memory):
# make symlink:
within_ancestry_diversity$ mkdir -p results/input/all/pops
within_ancestry_diversity$ ln -s /home/ecalfee/hilo/samples/alloMAIZE_bams.list results/input/all/pops/alloMAIZE.list
# run allele freq calc:
within_ancestry_diversity$ sbatch -p med2 --mem=24G --export="POP=alloMAIZE,PREFIX=all,DIR_SITES=../variant_sites/results/pass2_alloMAIZE,ALL" calcAlleleFreqPopByCounts.sh
Submitted batch job 10460993 - COMPLETED 4.24.19 (actually very fast)
# renamed allo.maize to match other naming convention

# allele freqs for all hilo populations and groups:
# NOTE: I changed the output folders from 'all' to 'pass2_alloMAIZE' to be more specific
# make symlinks:
within_ancestry_diversity$ for i in $(cat ../samples/pass2_pops/pop_labels.list); do ln -s /home/ecalfee/hilo/samples/pass2_pops/"$i"_bams.list results/input/all/pops/"$i".list; done
# run allele freq calc:
within_ancestry_diversity$ for i in $(cat ../samples/pass2_pops/pop_labels.list); do sbatch -p bigmemm --mem=16G --export="POP=$i,PREFIX=all,DIR_SITES=../variant_sites/results/pass2_alloMAIZE,ALL" calcAlleleFreqPopByCounts.sh; done
Submitted batch job 10461517-36; 10461636-49 - COMPLETED 4.24.19 (many jobs). Need to redo job 10461519 because accidentally called allo.maize not allo.mexicana:
within_ancestry_diversity$ sbatch -p bigmemm --mem=16G --export="POP=allo.mexicana,PREFIX=all,DIR_SITES=../variant_sites/results/pass2_alloMAIZE,ALL" calcAlleleFreqPopByCounts.sh
Submitted batch job 10478019 - COMPLETED 4.24.19

# tripsacum (likely I should be running this as genotype calling instead, but for now I can calc freqs):
within_ancestry_diversity$ ln -s /home/ecalfee/hilo/samples/trip_bams.list results/input/all/pops/trip.list
# run allele freq calc:
within_ancestry_diversity$ sbatch -p med2 --mem=24G --export="POP=trip,PREFIX=all,DIR_SITES=../variant_sites/results/pass2_alloMAIZE,ALL" calcAlleleFreqPopByCounts.sh
Submitted batch job 10461997 - COMPLETED 4.24.19



# Get pi and Fst estimates for the chr4 inversion.
# pi for all groups of haplotypes, e.g. sympatric maize homozygous for mexicana haplotypes
# Fst between allopatric maize (hom. maize hap), allopatric mexicana (hom. mexicana hap)
# and parviglumis
# (1) Identify individuals homozygous for maize or mexicana inversion type based on PCA for inv4m
# global_ancestry/plot_PCA.R creates the bam file lists for these individuals based on PC1 cutoffs
# e.g. file within_ancestry_diversity/results/inv4m/pass2_alloMAIZE/allopatric_mexicana.mexicana_hap.bams
# intermediate individuals are not included (and there are some allopatric mexicana that appear intermediate/heterozygous from PCA).
# make symlink for parviglumis (include all individuals in bam list for parviglumis)
hilo/within_ancestry_diversity/results/inv4m/pass2_alloMAIZE$ ln -s ../../../../samples/PalmarChico_IDs.list parviglumis.IDs
hilo/within_ancestry_diversity/results/inv4m/pass2_alloMAIZE$ ln -s ../../../../samples/PalmarChico_bams.list parviglumis.bams
# inv4m	4:171771502-185951149 on v4 coordinates but I add 1Mb to either end as additional buffer
within_ancestry_diversity$ sbatch --export=PREFIX=pass2_alloMAIZE piFstAngsd_inv4m.sh
Submitted batch job 11248326 - RUNNING 6.5.19. CANCELLED.
# Instead I want to run this in 2 parts: first priority is getting fst between allopatric maize and mex
# then run all 2nd priority pi and fst estimates (e.g. with parviglumis and sympatric pops)
# also made scripts general to any locus:
within_ancestry_diversity$ sbatch --export=PREFIX=pass2_alloMAIZE,LOCUS=inv4m,CHR=4,START=170771502,END=186951149 piFstAngsd_onelocus.sh
Submitted batch job 11248335 - RUNNING 6.5.19. COMPLETED.
within_ancestry_diversity$ sbatch --export=PREFIX=pass2_alloMAIZE,LOCUS=inv4m,CHR=4,START=170771502,END=186951149 piFstAngsd_onelocus_extra.sh
Submitted batch job 11248336 - RUNNING 6.5.19. OUT_OF_TIME (but finished thetas for all pops, just not parv-other Fst estimates)
# I could smooth out the results by increasing the window size (should be fast):
# script runs by default 5kb windows with a 1kb step: realSFS fst stats2 "$DIR_OUT/$pop1-$pop2.fst.idx" -win 5000 -step 1000 > "$DIR_OUT/$pop1-$pop2.fstWindows.stats"
# 50kb with 10kb step:
within_ancestry_diversity/results/inv4m/pass2_alloMAIZE$ pop1="allopatric_mexicana.mexicana_hap"; pop2="allopatric_maize.maize_hap"; realSFS fst stats2 "$pop1-$pop2.fst.idx" -win 50000 -step 10000 > $pop1-$pop2.50kb.fstWindows.stats
# and smoothing theta within-ancestry diversity estimates to 50kb windows (fast):
within_ancestry_diversity/results/inv4m/pass2_alloMAIZE$ for pop1 in allopatric_maize.maize_hap allopatric_mexicana.mexicana_hap parviglumis sympatric_maize.maize_hap sympatric_maize.mexicana_hap sympatric_mexicana.maize_hap sympatric_mexicana.mexicana_hap; do thetaStat do_stat "$pop1.thetas.idx" -win 50000 -step 10000 > $pop1.50kb.thetasWindows; done

# get allele frequencies for parviglumis, tripsacum, allopatric mexicana (excl non homozygous), allopatric maize, sympatric maize homozygous for mex/maize and sympatric mexicana homozygous for mex/maize
# then calculate pairwise dxy between all of these groups and estimate divergence time
# use all SNPs segregating in maize/mex/parv (dxy will be underestimated for pairs against tripsacum, but with all groups affected equally)
# SNPs: global_ancestry/results/thinnedSNPs/pass2_alloMAIZE_PalmarChico_inv4m_allSNPs/whole_genome.var.sites
# make symlink to tripsacum bam/ID
within_ancestry_diversity/results/inv4m/pass2_alloMAIZE$ ln -s /home/ecalfee/hilo/samples/trip_bams.list tripsacum.bams
within_ancestry_diversity/results/inv4m/pass2_alloMAIZE$ ln -s /home/ecalfee/hilo/samples/trip_IDs.list tripsacum.IDs
# make file with list of all haplotype populations, e.g. parviglumis, allopatric_maize.maize_hap
within_ancestry_diversity/results/inv4m/pass2_alloMAIZE/pops.list
calcAlleleFreq_onelocus.sh
# calculate allele frequencies across the inversion for each of my groups:
within_ancestry_diversity$ sbatch --array=0-7 --export="PREFIX=pass2_alloMAIZE_parviglumis_inv4m_allSNPs,DIR_POPS=results/inv4m/pass2_alloMAIZE" calcAlleleFreq_onelocus.sh

# also interesting locus on chr9:
# my outlier locus on chr9 associated with elevation I looked up and estimate bounds:
# 9:108413387-111859503
# this is a candidate for the mhl1 locus -- I need to look up how close it is to the genetic mapping of this locus


# NEW DATA - pass2_alloMAIZE - redo calling homozygous ancestry tracts (post > .8):
# Step 1: use R and bedtools to identify regions with homozygous ancestry for each individual:

# 1a: R script makes short tracts around variant sites: ancestry_sites_to_tracts.R
within_ancestry_diversity$ Rscript ./ancestry_sites_to_tracts.R pass2_alloMAIZE
COMPLETED (interactively on farm -- very fast)
# 1b: then use awk to identify which tracts have posterior > 0.8
# and bedtools to merge adjacent tracts (array 0-217 is all HILO ind's -- script will try (and fail) to find posteriors for allopatric mexicana, so I expect some failed jobs
within_ancestry_diversity$ sbatch --array=0-217 --export=PREFIX=pass2_alloMAIZE,PREFIX_HMM=output_noBoot get_homozyg_tracts_and_bams_mexicana.sh
Submitted batch job 11274982 - written over my maize tracts. FIX error & rerun:
Submitted batch job 11276814 - RUNNING 6.10.19
within_ancestry_diversity$ sbatch --array=0-217 --export=PREFIX=pass2_alloMAIZE,PREFIX_HMM=output_noBoot get_homozyg_tracts_and_bams_maize.sh
Submitted batch job 11275552 - FIX error & rerun:
Submitted batch job 11276999 - RUNNING 6.10.19



# TO DO:

# redo within-ancestry peaks for pass2 data
# (4) look up the estimated dates for very high maize ancestry prior run of maize local anc. inference

# TO DO: start by looking at mexicana ancestry in maize. Make a generic regions script, but set your first region = chr4 and see if it runs overnight. Use unfolded SFS.

# Get Fst (or pi between) for mexicana ancestry genomewide (be sure to include a comparison to allopatric maize). Compare this to Fst ignoring ancestry and Fst looking at homozygous maize ancestry genomewide. This grounds the ancestry calls. Specifically test for fst between sympatric vs. allopatric populations. Later I can separate out selected vs. just introgressed at low frequency pieces and see if they differ (but maybe I won't have enough homozygotes to truly test that).
# TO DO: test if a pi_between or fst scan for mexicana ancestry in maize is going to work by leaving one of my populations out (or individuals) with homozygous mexicana ancestry and testing it that way.

# Step 3: Calcuate pi (and SAF) per population

# 3a. make a file list of all populations to include (sympatric maize, sympatric mex, allo maize, allo mex in addition to
# individual sympatric populations)

# 3b. use ANGSD to calculate allele frequencies for each population (SAF)
# for segments that are maize homozygous, and separately for segments that are mexicana homozygous
# Q. DO I NEED FOLDED OR UNFOLDED SFS?

# 3c: use the results from step 3b to calculate pi-within using ANGSD

# Step 4: calculate Fst between all pairs of populations across the genome

# 4a. make a file list of all population pairs to calculate Fst between

# 4b. caculate 2DSFS for each pair of populations

# Step 5: Summarize statistics to characterize genomewide patterns but also
# large outlier regions individually
