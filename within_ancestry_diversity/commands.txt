# This analysis looks at within-ancestry diversity to assess
# (1) is there evidence of bottlenecks or sweeps for outlier introgressed regions
# This analysis compares pi within introgressed segments to pi within local and allopatric populations for the same regions
# (2) what is the likely source population for adaptive introgression and is it the same across populations?
# This analysis uses Fst calculations between introgressed segments and potential donor populations that are sympatric or allopatric

# Step 1: use R and bedtools to identify regions with homozygous ancestry for each individual:

# 1a: R script makes short tracts around variant sites: ancestry_sites_to_tracts.R
within_ancestry_diversity$ Rscript ./ancestry_sites_to_tracts.R ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM
# (I ran on barbara & copied result file over to farm. only need to run once for all chr and all samples)
# 1b: then use awk to identify which tracts have posterior > 0.8
# and bedtools to merge adjacent tracts
# TESTING:
hilo/within_ancestry_diversity$ pr -mt -s$'\t' results/input/var.sites.bed  \
<(tail -n +2 ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot/HILO1.posterior | cut -f3) \
| awk '$4 > 0.8 {print $0}' | bedtools merge -sorted -d 1 | head > results/input/hom_maize/tracts/HILO1.bed

# Step 2: use bedtools to filter bam files to only include regions homozygous for ancestry (identified in .bed files above)
# TESTING:
hilo/within_ancestry_diversity$ bedtools intersect -sorted -a ../filtered_bams/results/pass1/HILO1.sort.dedup.baq.bam \
-b results/input/hom_maize/tracts/HILO1.bed > results/input/hom_maize/bams/HILO1.sort.dedup.baq.bam

# running all HILO individuals with new script for 1b & 2 (find tracts and filter bams):
within_ancestry_diversity$ sbatch --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot get_homozyg_tracts_and_bams.sh
Submitted batch job 9175362 - cancelled (typo bams vs. bam) 2.27.19. rerunning:
Submitted batch job 9175657 - I CANCELLED 2.27.19. Actually, want to split into 2 scripts so I can prioritize looking at mexicana ancestry in maize:
within_ancestry_diversity$ sbatch --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot get_homozyg_tracts_and_bams_mexicana.sh
Submitted batch job 9175973 - RUNNING 2.27.19
within_ancestry_diversity$ sbatch --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_noBoot get_homozyg_tracts_and_bams_maize.sh
Submitted batch job 9176068 - RUNNING 2.27.19

# TO DO: for populations with no admixture from NGSadmix, either use all of bams, or rely
# on posteriors from very low (.001) admixture prior

# high maize prior:
output_very_high_maize_prior_noBoot - pops 361,369,371

within_ancestry_diversity$ sbatch -t 24:00:00 --array=$(for i in 361 369 371; do cat ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/input/pop"$i".anc_hmm.ids; done | sort --version-sort | paste -sd",") --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_very_high_maize_prior_noBoot get_homozyg_tracts_and_bams_mexicana.sh
Submitted batch job 9181138 - COMPLETED (fast) 2.27.19

within_ancestry_diversity$ sbatch -t 24:00:00 --array=$(for i in 361 369 371; do cat ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/input/pop"$i".anc_hmm.ids; done | sort --version-sort | paste -sd",") --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_very_high_maize_prior_noBoot get_homozyg_tracts_and_bams_maize.sh
Submitted batch job 9181158 - COMPLETELETED (fast) 2.27.19

# low maize prior:
output_very_high_mex_prior_noBoot - pops 25,27,31,(35 - used as allopatric pop in pass1; for now exclude)

within_ancestry_diversity$ sbatch -t 24:00:00 --array=$(for i in 25 27 31; do cat ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/input/pop"$i".anc_hmm.ids; done | sort --version-sort | paste -sd",") --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_very_high_mex_prior_noBoot get_homozyg_tracts_and_bams_mexicana.sh
Submitted batch job 9181177 - COMPLETED 2.27.19

within_ancestry_diversity$ sbatch -t 24:00:00 --array=$(for i in 25 27 31; do cat ../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/input/pop"$i".anc_hmm.ids; done | sort --version-sort | paste -sd",") --export=DIR_BAMS=../filtered_bams/results/pass1,DIR_POST=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/thinnedHMM/ancestry_hmm/output_very_high_mex_prior_noBoot get_homozyg_tracts_and_bams_maize.sh
Submitted batch job 9181198 - COMPLETED 2.27.19

# NEW PLAN: FOR A FIRST PASS, JUST CALCULATE ALLELE FREQ. FOR EACH POP. ONLY INCLUDING READS FROM HOMOZYGOUS REGIONS:
# THEN CALCULATE PI AND FST ESTIMATES FROM THESE ALLELE FREQs IN R -- I can refine this approach later.
# allele frequencies for allo4low16 maize and allopatric mexicana already exist:
hilo/data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt/maize.allo.4Low16/region_399.mafs.gz
hilo/data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt/mexicana.allo.withXochi35/region_399.mafs.gz
# and I already have the list of variant sites, e.g.:
hilo/data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt/region_163.var.sites

# get lists of bams to use from hilo populations:
within_ancestry_diversity$ mkdir -p results/input/mex2/pops; for i in $(awk '$1 != "n" && $11 >= 0.05 {print $3}' ../data/pass1_ids.txt | sort | uniq); do awk -v i=$i '$3 == i && $11 >= 0.05 {print "results/input/mex2/bams/HILO"$1".sort.dedup.baq.bam"}' ../data/pass1_ids.txt > results/input/mex2/pops/pop$i.list; done
within_ancestry_diversity$ mkdir -p results/input/maize2/pops; for i in $(awk '$1 != "n" && $11 >= 0.05 {print $3}' ../data/pass1_ids.txt | sort | uniq); do awk -v i=$i '$3 == i && $11 >= 0.05 {print "results/input/maize2/bams/HILO"$1".sort.dedup.baq.bam"}' ../data/pass1_ids.txt > results/input/maize2/pops/pop$i.list; done
# also make a list of new allopatric maize bams:
within_ancestry_diversity$ ls ../filtered_bams/results/alloMAIZE/*.sort.dedup.baq.bam | sort --version-sort > results/input/maize2/pops/landraces.list
# I can just use the already-calculated allele freq's for old allopatric maize and mex.

# start with getting allele frequencies for maize landraces:
within_ancestry_diversity$ sbatch --export="POP=landraces,PREFIX=maize2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL" calcAlleleFreqPopByCounts.sh
Submitted ****
# then for all populations (homozygous mexicana tracts):
within_ancestry_diversity$ for i in {18..31} {33..35} {360..363} {365..374}; do sbatch \
--export=POP=pop"$i",PREFIX=mex2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL \
calcAlleleFreqPopByCounts.sh; done
Submitted ****
# all populations homozygous maize tracts too:
within_ancestry_diversity$ for i in {18..31} {33..35} {360..363} {365..374}; do sbatch \
--export=POP=pop"$i",PREFIX=maize2,DIR_SITES=../data/geno_lik/merged_pass1_all_alloMaize4Low_16/allVar_depthFilt,ALL \
calcAlleleFreqPopByCounts.sh; done
Submitted ****



# TO DO: start by looking at mexicana ancestry in maize. Make a generic regions script, but set your first region = chr4 and see if it runs overnight. Use unfolded SFS.

# Step 3: Calcuate pi (and SAF) per population

# 3a. make a file list of all populations to include (sympatric maize, sympatric mex, allo maize, allo mex in addition to
# individual sympatric populations)

# 3b. use ANGSD to calculate allele frequencies for each population (SAF)
# for segments that are maize homozygous, and separately for segments that are mexicana homozygous
# Q. DO I NEED FOLDED OR UNFOLDED SFS?

# 3c: use the results from step 3b to calculate pi-within using ANGSD

# Step 4: calculate Fst between all pairs of populations across the genome

# 4a. make a file list of all population pairs to calculate Fst between

# 4b. caculate 2DSFS for each pair of populations

# Step 5: Summarize statistics to characterize genomewide patterns but also
# large outlier regions individually

# TO DO:
